---
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import BlogPostTeaser from '@/components/BlogPostTeaser.astro';

const { tag } = Astro.params;

if (!tag) {
  return Astro.redirect('/tags');
}

const allPosts = await getCollection('blog');
const filteredPosts = allPosts
  .filter(post => post.data.tags?.includes(tag))
  .sort((a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf());

const title = `Posts tagged with "${tag}"`;
const description = `All blog posts tagged with ${tag}.`;
const permalink = Astro.site?.href ? `${Astro.site.href}tags/${tag}` : `/tags/${tag}`;
---

<BaseLayout title={title} description={description} permalink={permalink}>
  <section class="py-12 md:py-20">
    <div class="container mx-auto px-4">
      <div class="mb-16">
        <div class="inline-flex w-full mx-auto items-start">
          <h1 class="font-heading text-3xl xs:text-5xl sm:text-7xl md:text-8xl lg:text-10xl tracking-tighter pt-4">Posts tagged with "{tag}"</h1>
        </div>
      </div>
      <div>
        {filteredPosts.length > 0 ? (
          filteredPosts.map((post) => (
            <BlogPostTeaser 
              url={`/blog/${post.slug}/`} 
              title={post.data.title} 
              pubDate={post.data.pubDate} 
              category={post.data.category} 
              heroImage={post.data.heroImage} 
              description={post.data.description} 
            />
          ))
        ) : (
          <p>No posts found with this tag.</p>
        )}
      </div>
    </div>
  </section>
</BaseLayout>
